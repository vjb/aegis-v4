PASS test/frontend.spec.ts (35.621 s)
  Phase 8.1 ‚Äî Wallet Info + Session Key Rendering
    ‚àö WalletInfo type has all required fields (55 ms)
    ‚àö truncates owner address to 0x109D‚Ä¶65Cf (2 ms)
    ‚àö truncates module address correctly (2 ms)
    ‚àö session key targets only the AegisModule (1 ms)
    ‚àö session key allows exactly 2 selectors (2 ms)
    ‚àö session key allows requestAudit (0xe34eac65) (1 ms)
    ‚àö session key allows triggerSwap (0x684bceb0) (1 ms)
    ‚àö session key does NOT allow transfer selector (57 ms)
    ‚àö session key budget is capped at 0.002 ETH (1 ms)
    ‚àö error field is optional in WalletInfo (2 ms)
  Phase 8.2 ‚Äî Oracle Feed: Risk Score & Verdict Logic
    ‚àö risk score 0 decodes to 8 all-clean checks (2 ms)
    ‚àö risk score 0 ‚Üí APPROVED verdict (9 ms)
    ‚àö risk score 4 (bit 2) ‚Üí Known Honeypot flagged (4 ms)
    ‚àö risk score 4 ‚Üí BLOCKED (22 ms)
    ‚àö risk score 36 = Honeypot (bit 2) + Privilege Escalation (bit 5) (2 ms)
    ‚àö risk score 255 flags all 8 bits (2 ms)
    ‚àö risk score 1 (bit 0) ‚Üí Unverified Code only (2 ms)
    ‚àö risk score 16 (bit 4) ‚Üí Obfuscated Tax only (2 ms)
    ‚àö risk score 128 (bit 7) ‚Üí Logic Bomb only (4 ms)
    ‚àö negative score ‚Üí ERROR verdict (7 ms)
  Phase 8.2 ‚Äî Oracle Feed: SSE Event Parsing
    ‚àö parses phase event (1 ms)
    ‚àö parses tx event with hash (38 ms)
    ‚àö parses final_verdict BLOCKED event (3 ms)
    ‚àö parses final_verdict APPROVED event (3 ms)
    ‚àö parses llm-reasoning-start for GPT-4o (2 ms)
    ‚àö parses static-analysis GoPlus event (1 ms)

PASS test/session_key.spec.ts (48.419 s)
  getSmartSessionValidatorModule (unit)
    ‚àö returns type=validator (not executor) (149 ms)
    ‚àö has the canonical SmartSessions validator address (2 ms)
  AegisModule function selectors (unit)
    ‚àö requestAudit(address) selector is 4 bytes (2 ms)
    ‚àö triggerSwap(address,uint256,uint256) selector is 4 bytes (2 ms)
    ‚àö selectors are distinct (no collision) (2 ms)
  buildAgentSession (unit)
    ‚àö specifies the SmartSessions validator as session validator (7 ms)
    ‚àö encodes agent address in sessionValidatorInitData (209 ms)
    ‚àö permits exactly 2 actions (requestAudit + triggerSwap) (6 ms)
    ‚àö first action targets AegisModule with requestAudit selector (5 ms)
    ‚àö second action targets AegisModule with triggerSwap selector (3 ms)
    ‚àö has a 32-byte salt (4 ms)
  SESSION_MODES (unit)
    ‚àö USE mode = 0x00 (agent presents existing signed session) (3 ms)
    ‚àö ENABLE mode = 0x01 (agent enables + uses in same UserOp) (1 ms)
    ‚àö UNSAFE_ENABLE mode = 0x02 (skip policy checks ‚Äî dev only) (2 ms)

PASS test/bot.spec.ts (68.261 s)
  AegisAgent V5 ‚Äî ERC-4337 Bot
    ‚àö validates required config fields exist (44 ms)
    ‚àö requestAudit calldata contains target token address (8 ms)
    ‚àö triggerSwap calldata contains token address and 1 ETH amount (2 ms)
    ‚àö agent design: gas wallet is separate from Smart Account (capital custody) (2 ms)
    ‚àö risk matrix bit decoding identifies correct flags (4 ms)
    ‚àö polling returns false if no clearance event after timeout (66 ms)

FAIL test/safe_setup.spec.ts
  ‚óè Test suite failed to run

    [96mtest/safe_setup.spec.ts[0m:[93m88[0m:[93m41[0m - [91merror[0m[90m TS2339: [0mProperty 'deploySafeWithAegisModule' does not exist on type 'typeof import("C:/Users/vjbel/hacks/aegis-v4/scripts/v5_setup_safe")'.

    [7m88[0m         deploySafeWithAegisModule = mod.deploySafeWithAegisModule;
    [7m  [0m [91m                                        ~~~~~~~~~~~~~~~~~~~~~~~~~[0m

FAIL test/live_e2e.spec.ts
  ‚óè Test suite failed to run

    [96mtest/live_e2e.spec.ts[0m:[93m44[0m:[93m5[0m - [91merror[0m[90m TS2459: [0mModule '"permissionless/clients/pimlico"' declares 'entryPoint07Address' locally, but it is not exported.

    [7m44[0m     entryPoint07Address,
    [7m  [0m [91m    ~~~~~~~~~~~~~~~~~~~[0m

      [96mnode_modules/.pnpm/permissionless@0.3.4_viem@2_ca3529062a6ceeefc47c2d83e775e92c/node_modules/permissionless/clients/pimlico.ts[0m:[93m18[0m:[93m5[0m
        [7m18[0m     entryPoint07Address,
        [7m  [0m [96m    ~~~~~~~~~~~~~~~~~~~[0m
        'entryPoint07Address' is declared here.
    [96mtest/live_e2e.spec.ts[0m:[93m46[0m:[93m8[0m - [91merror[0m[90m TS1192: [0mModule '"C:/Users/vjbel/hacks/aegis-v4/node_modules/.pnpm/dotenv@16.6.1/node_modules/dotenv/lib/main"' has no default export.

    [7m46[0m import dotenv from "dotenv";
    [7m  [0m [91m       ~~~~~~[0m
    [96mtest/live_e2e.spec.ts[0m:[93m95[0m:[93m13[0m - [91merror[0m[90m TS2322: [0mType 'any' is not assignable to type 'never'.
      The intersection 'Client<Transport<string, Record<string, any>, EIP1193RequestFn<undefined, false>>, Chain<ChainFormatters, Record<string, unknown>>, JsonRpcAccount<...> | { ...; }, undefined, { ...; }>' was reduced to 'never' because property 'cacheTime' has conflicting types in some constituents.

    [7m95[0m             client: publicClient,
    [7m  [0m [91m            ~~~~~~[0m

      [96mnode_modules/.pnpm/permissionless@0.3.4_viem@2_ca3529062a6ceeefc47c2d83e775e92c/node_modules/permissionless/accounts/safe/toSafeSmartAccount.ts[0m:[93m1159[0m:[93m5[0m
        [7m1159[0m     client: Client<
        [7m    [0m [96m    ~~~~~~[0m
        The expected type comes from property 'client' which is declared here on type 'ToSafeSmartAccountParameters<"0.7", `0x${string}`>'
    [96mtest/live_e2e.spec.ts[0m:[93m112[0m:[93m74[0m - [91merror[0m[90m TS2737: [0mBigInt literals are not available when targeting lower than ES2020.

    [7m112[0m             calls: [{ to: safeAccount.address, data: "0x" as Hex, value: 0n }],
    [7m   [0m [91m                                                                         ~~[0m
    [96mtest/live_e2e.spec.ts[0m:[93m157[0m:[93m61[0m - [91merror[0m[90m TS2737: [0mBigInt literals are not available when targeting lower than ES2020.

    [7m157[0m             functionName: "onReportDirect", args: [tradeId, 0n],
    [7m   [0m [91m                                                            ~~[0m
    [96mtest/live_e2e.spec.ts[0m:[93m176[0m:[93m45[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 1.

    [7m176[0m         const swapData = encodeFunctionData({
    [7m   [0m [91m                                            ~[0m
    [7m177[0m             abi: AEGIS_MODULE_ABI,
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m179[0m             args: [MOCK_BRETT, parseEther("0.001"), 1n],
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m180[0m         });
    [7m   [0m [91m~~~~~~~~~[0m
    [96mtest/live_e2e.spec.ts[0m:[93m179[0m:[93m53[0m - [91merror[0m[90m TS2737: [0mBigInt literals are not available when targeting lower than ES2020.

    [7m179[0m             args: [MOCK_BRETT, parseEther("0.001"), 1n],
    [7m   [0m [91m                                                    ~~[0m
    [96mtest/live_e2e.spec.ts[0m:[93m182[0m:[93m58[0m - [91merror[0m[90m TS2737: [0mBigInt literals are not available when targeting lower than ES2020.

    [7m182[0m             calls: [{ to: MODULE, data: swapData, value: 0n }],
    [7m   [0m [91m                                                         ~~[0m
    [96mtest/live_e2e.spec.ts[0m:[93m204[0m:[93m61[0m - [91merror[0m[90m TS2737: [0mBigInt literals are not available when targeting lower than ES2020.

    [7m204[0m             functionName: "onReportDirect", args: [tradeId, 4n],
    [7m   [0m [91m                                                            ~~[0m
    [96mtest/live_e2e.spec.ts[0m:[93m219[0m:[93m45[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 1.

    [7m219[0m         const swapData = encodeFunctionData({
    [7m   [0m [91m                                            ~[0m
    [7m220[0m             abi: AEGIS_MODULE_ABI,
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m222[0m             args: [MOCK_HONEYPOT, parseEther("0.001"), 1n],
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m223[0m         });
    [7m   [0m [91m~~~~~~~~~[0m
    [96mtest/live_e2e.spec.ts[0m:[93m222[0m:[93m56[0m - [91merror[0m[90m TS2737: [0mBigInt literals are not available when targeting lower than ES2020.

    [7m222[0m             args: [MOCK_HONEYPOT, parseEther("0.001"), 1n],
    [7m   [0m [91m                                                       ~~[0m
    [96mtest/live_e2e.spec.ts[0m:[93m227[0m:[93m62[0m - [91merror[0m[90m TS2737: [0mBigInt literals are not available when targeting lower than ES2020.

    [7m227[0m                 calls: [{ to: MODULE, data: swapData, value: 0n }],
    [7m   [0m [91m                                                             ~~[0m

PASS test/bot_v5.spec.ts (75.85 s)
  buildV5RequestAuditCall (unit)
    ‚àö targets AegisModule (NOT the Safe directly) (25 ms)
    ‚àö attaches zero ETH value (treasury pays, not the agent) (3 ms)
    ‚àö encodes requestAudit(address) selector correctly (3 ms)
    ‚àö encodes the token address as the only argument (3 ms)
  buildV5TriggerSwapCall (unit)
    ‚àö targets AegisModule (6 ms)
    ‚àö attaches zero ETH value (module treasury provides ETH for swaps) (13 ms)
    ‚àö encodes triggerSwap(address,uint256,uint256) ‚Äî 3 params (2 ms)
    ‚àö defaults amountOutMinimum to 1 (contract requires non-zero) (2 ms)
    ‚àö is distinct from requestAudit calldata (different selector) (4 ms)
  V5 vs V5 call structure
    ‚àö V5 triggerSwap has 3 params, V5 'bot.ts' ABI had only 2 (bug fixed) (3 ms)
  ERC-7715 Session Key Constraints (5.5.2)
    ‚àö session key targets ONLY the AegisModule address (5 ms)
    ‚àö session permits exactly 2 selectors: requestAudit + triggerSwap (7 ms)
    ‚àö session DOES NOT permit arbitrary function selectors (e.g. ETH drain) (2 ms)
    ‚àö session DOES NOT permit calling a random contract (only AegisModule) (1 ms)
    ‚àö session uses the SmartSessionsValidator (Rhinestone canonical) (1 ms)
    ‚àö session key = agent public address (embedded in initData) (1 ms)

PASS test/oracle.spec.ts (76.321 s)
  Aegis CRE Oracle V5 ‚Äî ABI encoding
    ‚àö encodes (tradeId=3, riskScore=0) to 64-byte ABI-encoded hex (26 ms)
    ‚àö encodes (tradeId=0, riskScore=4) ‚Äî honeypot flag (2 ms)
    ‚àö encodes riskScore=255 (all risk bits set) (2 ms)
    ‚àö oracle config vaultAddress points to AegisModule (2 ms)
    ‚àö V5 config shape has required CRE fields (6 ms)
    ‚àö V3 and V5 onReport ABI encoding is identical (same uint256,uint256 schema) (3 ms)
  Oracle AI JSON ‚Üí onReportDirect hex payload (5.5.3)
    ‚àö AI response {"risk": 5} ‚Üí correct hex payload for onReportDirect (3 ms)
    ‚àö AI response {"risk": 0} ‚Üí approved (clean token) (2 ms)
    ‚àö AI response {"risk": 36} ‚Üí denied (honeypot + privilege escalation) (3 ms)
    ‚àö calldata length is always exactly 138 chars (4+32+32 bytes) (3 ms)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Test Suites: 2 failed, 5 passed, 7 total
Tests:       72 passed, 72 total
Snapshots:   0 total
Time:        78.894 s
Ran all test suites.
