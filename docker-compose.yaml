services:
  cre-node:
    build:
      context: ./cre-node
      dockerfile: Dockerfile
    container_name: aegis-oracle-node
    volumes:
      # LIVE VOLUME MAPPING:
      # This maps your local /cre-node folder to the /app folder in the container.
      # Any code changes you make in VS Code are instantly visible to the CRE CLI.
      - ./cre-node:/app
      # Map your root .env so secrets are available for simulation
      - ./.env:/app/.env
      # Map the global CLI credentials so 'cre login' survives rebuilds
      - ~/.cre:/root/.cre
    env_file:
      - .env
    environment:
      - NODE_ENV=development
    # Standard terminal support
    tty: true
    stdin_open: true

  # ── V5: Alto ERC-4337 Bundler (local, Tenderly VNet) ──────────────────────
  # Used in Phases 2-5 for local UserOperation simulation.
  # Phase 5+ switches to Pimlico hosted bundler on Base Sepolia.
  alto-bundler:
    image: node:20-alpine
    container_name: aegis-alto-bundler
    env_file:
      - .env
    environment:
      - NODE_ENV=development
    ports:
      - "4337:4337"
    # EntryPoint v0.7 (EIP-4337 canonical) — deployed on Base and most forks
    command: >
      sh -c "npx --yes @pimlico/alto@latest -e 0x0000000071727De22E5E9d8BAf0edAc6f37da032 -r ${TENDERLY_RPC_URL} -x ${PRIVATE_KEY} --port 4337 --rpc-gas-estimate"
    # Comment out if you don't want the bundler running alongside the oracle
    profiles:
      - v5
